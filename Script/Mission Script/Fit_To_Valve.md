/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*

# Define Variable
global_bool gb_bool_kinova_force_ctrl_rst = true;

# Title: Valve Recognition

## Step0: Align to Panel
KINOVA_ALIGN_TO_PANEL.do_init_motion = false
KINOVA_ALIGN_TO_PANEL_FUNCTION()

A_Sleep(1000)

## Step1: LRF-Kinova Vertical CTRL

IF(gi_valve_size > 19)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ++0.05
/*KINOVA_MANIPULATE_STRUCT.z = 0.2223

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step2: LRF-Kinova Vertical CTRL(New)

LRF_K_VERTICAL_CTRL_STRUCT.mode = 3

LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 300
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step3: Vehicle Horizen Control(Using LRF)
/* unit is mm

LRF_V_HORIZEN_CTRL_STRUCT.mode = 2

LRF_V_HORIZEN_CTRL_STRUCT.desired_h_dst = 360

LRF_V_HORIZEN_CTRL_STRUCT.error = 20

LRF_V_HORIZEN_CTRL_STRUCT.s_deg = 10
LRF_V_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_V_HORIZEN_CTRL_STRUCT.velocity = 50

LRF_V_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_V_HORIZEN_CTRL_STRUCT.loop_sleep = 500

LRF_V_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step0: Align to Panel

IF(!gb_bool_kinova_force_ctrl_rst)
KINOVA_ALIGN_TO_PANEL.do_init_motion = false
KINOVA_ALIGN_TO_PANEL_FUNCTION()

A_Sleep(500)

## Step5: Wrench Grasp

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1800
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1900
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = -2

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step5: Wrench Grasp

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1680
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1600
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 180

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step6: Gripper Release

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 2500
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 2500
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = -2

GRIPPER_FORCE_CTRL_FUNCTION()

## Step7: KINOVA Angle Control(New, Using Dynamixel Pro-LRF)
/* mode =2 => Left
LRF_K_ANGLE_CTRL_STRUCT.mode = 2

LRF_K_ANGLE_CTRL_STRUCT.error = 0.3
LRF_K_ANGLE_CTRL_STRUCT.desired_angle = -0.5

LRF_K_ANGLE_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_ANGLE_CTRL_STRUCT.s_deg = 10
LRF_K_ANGLE_CTRL_STRUCT.e_deg = 170

LRF_K_ANGLE_CTRL_STRUCT.unit_deg = 0.3

LRF_K_ANGLE_CTRL_STRUCT.loop_sleep = 30

LRF_K_ANGLE_CTRL_FUNCTION()

A_Sleep(500)

## Step8: LRF-Kinova Vertical CTRL

LRF_K_VERTICAL_CTRL_STRUCT.mode = 2

LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 240
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step7: KINOVA Angle Control(New, Using Dynamixel Pro-LRF)
/* mode =2 => Left
LRF_K_ANGLE_CTRL_STRUCT.mode = 2

LRF_K_ANGLE_CTRL_STRUCT.error = 0.3
LRF_K_ANGLE_CTRL_STRUCT.desired_angle = -0.5

LRF_K_ANGLE_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_ANGLE_CTRL_STRUCT.s_deg = 10
LRF_K_ANGLE_CTRL_STRUCT.e_deg = 170

LRF_K_ANGLE_CTRL_STRUCT.unit_deg = 0.3

LRF_K_ANGLE_CTRL_STRUCT.loop_sleep = 30

LRF_K_ANGLE_CTRL_FUNCTION()

A_Sleep(500)

## Step9: LRF-Kinova Horizen CTRL
LRF_K_HORIZEN_CTRL_STRUCT.mode = 2

LRF_K_HORIZEN_CTRL_STRUCT.only_sensing_moving = false

LRF_K_HORIZEN_CTRL_STRUCT.desired_h_dst = 335
/*Center Point
/*LRF_K_HORIZEN_CTRL_STRUCT.desired_h_dst = 335

LRF_K_HORIZEN_CTRL_STRUCT.error = 1.0

LRF_K_HORIZEN_CTRL_STRUCT.s_deg = 10 
LRF_K_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_K_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_K_HORIZEN_CTRL_STRUCT.loop_sleep = 30 

LRF_K_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step10: LRF-Kinova Vertical CTRL

LRF_K_VERTICAL_CTRL_STRUCT.mode = 2

LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 180
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

# Step11: Correct Fit to valve pose 

KINOVA_FIT_TO_VALVE_POSE_STRUCT.valve_size = gi_valve_size
KINOVA_FIT_TO_VALVE_POSE_STRUCT.valve_rotation_angle = gb_valve_rotation

/*[cm/s]
KINOVA_FIT_TO_VALVE_POSE_STRUCT.move_step = 1.8 

KINOVA_FIT_TO_VALVE_POSE_STRUCT.angle_step = 19

KINOVA_FIT_TO_VALVE_POSE_FUNCTION()

## Step12: KINOVA Force CTRL(Down)

/*gi_valve_size
KINOVA_FORCE_CTRL_STRUCT.mode = 2
KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 13

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
/*KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.3212
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.250

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = -0.05

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(1000)

## Step13: If FALE to fit...Up

IF(!gb_bool_kinova_force_ctrl_rst)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ++0.08
/*KINOVA_MANIPULATE_STRUCT.z = 0.2223

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step14: If FALE to fit...Back

IF(!gb_bool_kinova_force_ctrl_rst)

KINOVA_MANIPULATE_STRUCT.x = --0.08
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step15: Gripper Close

IF(gb_bool_kinova_force_ctrl_rst)

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1700
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1750
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 130

GRIPPER_FORCE_CTRL_FUNCTION()

/*Else Go to 0 Step*/DGDG
ELSE(GoTo:5)

A_Sleep(1000)

## Step19: Gripper Release 

GRIPPER_GO_TO_REL_POSE_STRUCT.pose_1 = 10
GRIPPER_GO_TO_REL_POSE_STRUCT.pose_2 = 10

GRIPPER_GO_TO_REL_POSE_FUNCTION()

## Step16: Magnet OFF

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = false

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step17: Rotate Valve(Turn Left)
 
KINOVA_ROTATE_VALVE_STRUCT.using_current_coord = false

KINOVA_ROTATE_VALVE_STRUCT.center_x = 0
KINOVA_ROTATE_VALVE_STRUCT.center_y = 0
KINOVA_ROTATE_VALVE_STRUCT.center_z = 0.1686

KINOVA_ROTATE_VALVE_STRUCT.theta = 55

KINOVA_ROTATE_VALVE_STRUCT.wrench_size = gi_valve_size
KINOVA_ROTATE_VALVE_STRUCT.valve_rotation_angle = gb_valve_rotation

KINOVA_ROTATE_VALVE_STRUCT.radius_16mm = 12
KINOVA_ROTATE_VALVE_STRUCT.radius_17mm = 14
KINOVA_ROTATE_VALVE_STRUCT.radius_18mm = 16
KINOVA_ROTATE_VALVE_STRUCT.radius_19mm = 16
KINOVA_ROTATE_VALVE_STRUCT.radius_22mm = 17
KINOVA_ROTATE_VALVE_STRUCT.radius_24mm = 18

KINOVA_ROTATE_VALVE_STRUCT.radius_offset_mm = 1.5

KINOVA_ROTATE_VALVE_STRUCT.init_angle = false

KINOVA_ROTATE_VALVE_FUNCTION()

## Step18: Grasp1

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1650
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 200

GRIPPER_FORCE_CTRL_FUNCTION()

## Step20: Magnet ON

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

##########################################_MISSION_END_##########################################
