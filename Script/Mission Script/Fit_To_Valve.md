/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*
# Define Variable
global_bool gb_bool_kinova_force_ctrl_rst = true;

# Title: Fit To Valve

## Step0: Vehicle Moving
VEHICLE_LOCALIZATION_ON_PANEL_STRUCT.desired_h_dst = 0.47
VEHICLE_LOCALIZATION_ON_PANEL_FUNCTION()

## Step1: Align to Panel

KINOVA_ALIGN_TO_PANEL.do_init_motion = false
KINOVA_ALIGN_TO_PANEL_FUNCTION()

A_Sleep(3000)

## Step2: LRF-Kinova Vertical CTRL(NEW Using Scara)

LRF_K_VERTICAL_CTRL_STRUCT.mode = 4
LRF_K_VERTICAL_CTRL_STRUCT.force_option = false
LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 190
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(3000)

## Step3: Vehicle Moving
VEHICLE_LOCALIZATION_ON_PANEL_STRUCT.desired_h_dst = 0.42
VEHICLE_LOCALIZATION_ON_PANEL_FUNCTION()


## Step4: KINOVA Angle Control(New, Using Dynamixel Pro-LRF)
/* mode =2 => Left
LRF_K_ANGLE_CTRL_STRUCT.mode = 2

LRF_K_ANGLE_CTRL_STRUCT.error = 0.3
LRF_K_ANGLE_CTRL_STRUCT.desired_angle = 0
/*LRF_K_ANGLE_CTRL_STRUCT.desired_angle = 0

LRF_K_ANGLE_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_ANGLE_CTRL_STRUCT.s_deg = 10
LRF_K_ANGLE_CTRL_STRUCT.e_deg = 170

LRF_K_ANGLE_CTRL_STRUCT.unit_deg = 1

LRF_K_ANGLE_CTRL_STRUCT.loop_sleep = 30

LRF_K_ANGLE_CTRL_FUNCTION()

A_Sleep(300)

## Step5: Gripper Grasp

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1550
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1550
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 350

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step6: LRF-Kinova Vertical CTRL(NEW Using Scara)

LRF_K_VERTICAL_CTRL_STRUCT.mode = 2
LRF_K_VERTICAL_CTRL_STRUCT.force_option = false
LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 180
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(3000)

## Step7: Kinova Arm Go Right

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = --0.09
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step8: Kinova Arm Down

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
/*KINOVA_MANIPULATE_STRUCT.z = 0.1174
KINOVA_MANIPULATE_STRUCT.z = 0.1423

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step14: Kinova Force Control(Go Forward)

KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.mode = 1

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 5
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 0

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0.5500
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0.05
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = 0

KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(1000)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.05
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1500)


## Step6: KINOVA Force Ctrl(Go Left)
KINOVA_FORCE_CTRL_STRUCT.mode = 1
KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 18
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 0

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = -0.2017
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0.09
KINOVA_FORCE_CTRL_STRUCT.move_step_z = 0

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(500)


## Step11: Kinova Arm Go Right

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = --0.012
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step11: Kinova Arm Go Back

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = --0.10
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step11: Kinova Arm Go Left

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ++0.04
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)


## Step5: Gripper Release

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 2800
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 2800
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = -2

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step14: Kinova Force Control(Go Forward)

KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.mode = 1

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 8
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 0

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0.5500
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0.05
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = 0

KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(300)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.018
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step16: Find Valve Location Recognition(Using Gripper)

FIND_VALVE_LOCATION_STRUCT.grap_error = 3
FIND_VALVE_LOCATION_STRUCT.grasp_pose_1 = 1570
FIND_VALVE_LOCATION_STRUCT.grasp_pose_2 = 1570

FIND_VALVE_LOCATION_STRUCT.release_pose_1 = 1950
FIND_VALVE_LOCATION_STRUCT.release_pose_2 = 1950

FIND_VALVE_LOCATION_STRUCT.force_threshold = 90

FIND_VALVE_LOCATION_STRUCT.trial = 18

FIND_VALVE_LOCATION_STRUCT.valve_size = gi_valve_size
FIND_VALVE_LOCATION_STRUCT.valve_rotation = gb_valve_rotation

FIND_VALVE_LOCATION_FUNCTION()

A_Sleep(500)

## Step17: LRF-Kinova Vertical CTRL

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.4104

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.5575
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(2000)

## Step14: Kinova Force Control(Go Forward)

KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.mode = 1

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 9
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 0

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0.5500
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0.05
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = 0

KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(300)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.005
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.005
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.005
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step15: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.03
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 15

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step20: Wrench Grasp-GraspPose

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1550
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1550
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 350

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step21: KINOVA Force CTRL(Down)

KINOVA_FORCE_CTRL_STRUCT.mode = 2
KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 15

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
/*KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.3212
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.1974

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = -0.07

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step22: If FALE to fit...Back

IF(!gb_bool_kinova_force_ctrl_rst)

KINOVA_MANIPULATE_STRUCT.x = --0.10
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step23: If FALE to fit...Up

IF(!gb_bool_kinova_force_ctrl_rst)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ++0.08
/*KINOVA_MANIPULATE_STRUCT.z = 0.2223

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step21: KINOVA Manipulate(Up)
IF(gb_bool_kinova_force_ctrl_rst)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ++0.015

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

ELSE(GoTo:5)
## Step32: Magnet ON

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()

A_Sleep(1000)


## Step21: KINOVA Force CTRL(Go Right)

KINOVA_FORCE_CTRL_STRUCT.mode = 1
KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 11
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = 0

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = -0.5034
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = -0.03
KINOVA_FORCE_CTRL_STRUCT.move_step_z = 0

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()

A_Sleep(500)


## Step21: KINOVA Manipulate(Dw)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = --0.01

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)


## Step32: Magnet OFF

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = false

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step18: Gripper Release

GRIPPER_GO_TO_REL_POSE_STRUCT.pose_1 = 30
GRIPPER_GO_TO_REL_POSE_STRUCT.pose_2 = 30

GRIPPER_GO_TO_REL_POSE_FUNCTION()

A_Sleep(500)


## Step31: Rotate Valve - 1
 
KINOVA_ROTATE_VALVE_STRUCT.using_current_coord = false

KINOVA_ROTATE_VALVE_STRUCT.center_x = 0
KINOVA_ROTATE_VALVE_STRUCT.center_y = 0
KINOVA_ROTATE_VALVE_STRUCT.center_z = 0.1168

KINOVA_ROTATE_VALVE_STRUCT.theta = 80

KINOVA_ROTATE_VALVE_STRUCT.wrench_size = gi_valve_size
KINOVA_ROTATE_VALVE_STRUCT.valve_rotation_angle = 0

KINOVA_ROTATE_VALVE_STRUCT.radius_16mm = 14
KINOVA_ROTATE_VALVE_STRUCT.radius_17mm = 16
KINOVA_ROTATE_VALVE_STRUCT.radius_18mm = 14
KINOVA_ROTATE_VALVE_STRUCT.radius_19mm = 14
KINOVA_ROTATE_VALVE_STRUCT.radius_22mm = 14
KINOVA_ROTATE_VALVE_STRUCT.radius_24mm = 14

KINOVA_ROTATE_VALVE_STRUCT.radius_offset_mm = 1

KINOVA_ROTATE_VALVE_STRUCT.init_angle = true

KINOVA_ROTATE_VALVE_FUNCTION()

A_Sleep(500)

## Step31: Grasp1

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1570
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1570
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 350

GRIPPER_FORCE_CTRL_FUNCTION()


## Step32: Magnet On

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()

A_Sleep(1000)


##########################################_MISSION_END_##########################################
