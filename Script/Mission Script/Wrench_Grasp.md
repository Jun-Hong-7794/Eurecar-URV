/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*
/*<
# Title: Valve Recognition

## Step0: Kinova Arm Up

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.4106

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step0: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 270
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 2

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 150

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

# Step1: LRF-Vehicle Horizen CTRL
IF(gi_wrench_hanger_index > 3)

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.desired_avr_inlier_deg = 87.5
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.error_deg_boundary = 1

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.s_deg = 30
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.e_deg = 150

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.inlier_distance = 800


LRF_VEHICLE_HORIZEN_CTRL_STRUCT.velocity = 77

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_VEHICLE_HORIZEN_CTRL_FUNCTION()

# Step2: LRF-Vehicle Horizen CTRL
IF(gi_wrench_hanger_index < 4)
/*>

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.desired_avr_inlier_deg = 87.5
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.error_deg_boundary = 1

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.s_deg = 30
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.e_deg = 150

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.inlier_distance = 800


LRF_VEHICLE_HORIZEN_CTRL_STRUCT.velocity = 77

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_VEHICLE_HORIZEN_CTRL_FUNCTION()

## Step1: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 240
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 2

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 50
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 130

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step2: LRF-Kinova Horizen CTRL

LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_hanger_index = gi_wrench_hanger_index

/*LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_hanger_index = 1

LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_1 = 96.0 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_2 = 98.5 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_3 = 102 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_4 = 105.5 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_5 = 110.5 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.wrench_location_deg_6 = 117

LRF_KINOVA_HORIZEN_CTRL_STRUCT.desired_inlier_deg_avr = 0

LRF_KINOVA_HORIZEN_CTRL_STRUCT.error = 0.25

LRF_KINOVA_HORIZEN_CTRL_STRUCT.s_deg = 30 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.e_deg = 150

LRF_KINOVA_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_HORIZEN_CTRL_STRUCT.loop_sleep = 30 
LRF_KINOVA_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step3: Kinova Arm Down 

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.3457

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step4: Magnet On

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step5: Kinova Arm Forward

KINOVA_MANIPULATE_STRUCT.x = ++0.12
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(4000)

## Step6: Kinova Arm Backward

KINOVA_MANIPULATE_STRUCT.x = --0.12
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(2000)

##Step7: Wrench Check!

KINOVA_FORCE_CHECK_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CHECK_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CHECK_STRUCT.force_threshold_z = 6.5

KINOVA_FORCE_CHECK_STRUCT.check_count = 20

KINOVA_FORCE_CHECK_FUNCTION()

## Step8: Grasp2

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1700
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 130

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(2000)

## Step9: Align to Panel

KINOVA_ALIGN_TO_PANEL_FUNCTION()

##########################################_MISSION_END_##########################################
