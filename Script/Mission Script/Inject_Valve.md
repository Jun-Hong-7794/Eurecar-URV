/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*

# Define Variable
global_bool gb_bool_kinova_force_ctrl_rst = true;

# Title: Valve Recognition

## Step0: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 270
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 2

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 150

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step1: Vehicle Horizen Control(Using LRF)
/* unit is mm

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.desired_avr_inlier_deg = 87.5
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.error_deg_boundary = 1

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.s_deg = 30
LRF_VEHICLE_HORIZEN_CTRL_STRUCT.e_deg = 150

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.inlier_distance = 800


LRF_VEHICLE_HORIZEN_CTRL_STRUCT.velocity = 77

LRF_VEHICLE_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_VEHICLE_HORIZEN_CTRL_FUNCTION()

## Step2: Vehicle Angle Control(Using LRF)
/* unit is mm
LRF_VEHICLE_ANGLE_CTRL_STRUCT.desired_angle = 2
LRF_VEHICLE_ANGLE_CTRL_STRUCT.error_boundary = 0.5

LRF_VEHICLE_ANGLE_CTRL_STRUCT.s_deg = 45
LRF_VEHICLE_ANGLE_CTRL_STRUCT.e_deg = 135

LRF_VEHICLE_ANGLE_CTRL_STRUCT.velocity = 60

LRF_VEHICLE_ANGLE_CTRL_STRUCT.sensor_option = false

LRF_VEHICLE_ANGLE_CTRL_FUNCTION()

## Step3: Gripper Release

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 2500
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 2500
GRIPPER_FORCE_CTRL_STRUCT.forece_threshold = 200

GRIPPER_FORCE_CTRL_FUNCTION()

## Step4: Go to Rotate Z-Position

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)


## Step5: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 351
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 1

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 110
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step6: LRF-Kinova Horizen CTRL

LRF_KINOVA_HORIZEN_CTRL_STRUCT.desired_inlier_deg_avr = 82.0
LRF_KINOVA_HORIZEN_CTRL_STRUCT.error = 0.5

LRF_KINOVA_HORIZEN_CTRL_STRUCT.s_deg = 30
LRF_KINOVA_HORIZEN_CTRL_STRUCT.e_deg = 150

LRF_KINOVA_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_HORIZEN_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_HORIZEN_CTRL_FUNCTION()

A_Sleep(1000)

/*gb_valve_rotation

## Step7: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 178
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 1

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 110
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

# Step8: Correct Fit to valve pose 

KINOVA_FIT_TO_VALVE_POSE_STRUCT.valve_size = gi_valve_size
KINOVA_FIT_TO_VALVE_POSE_STRUCT.valve_rotation_angle = gb_valve_rotation
KINOVA_FIT_TO_VALVE_POSE_STRUCT.move_step = 19
KINOVA_FIT_TO_VALVE_POSE_STRUCT.angle_step = 19

KINOVA_FIT_TO_VALVE_POSE_FUNCTION()

## Step8: KINOVA Force CTRL

KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = -1

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.2748

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = -0.05

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()
A_Sleep(1000)

## Step9: Gripper Release

/*IF(gb_bool_kinova_force_ctrl_rst)
/*IF(false)

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1780
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 80

GRIPPER_FORCE_CTRL_FUNCTION()

/*Else Go to 0 Step*/
/*ELSE(GoTo:0)

## Step10: Magnet OFF

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = false

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step11: Go to Rotate Z-Position

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step12: Rotate Valve

KINOVA_ROTATE_VALVE_STRUCT.using_current_coord = true

KINOVA_ROTATE_VALVE_STRUCT.center_x = 0
KINOVA_ROTATE_VALVE_STRUCT.center_y = 0
KINOVA_ROTATE_VALVE_STRUCT.center_z = 0.1503

KINOVA_ROTATE_VALVE_STRUCT.theta = -45
KINOVA_ROTATE_VALVE_STRUCT.radius = 18

KINOVA_ROTATE_VALVE_STRUCT.init_angle = false

KINOVA_ROTATE_VALVE_FUNCTION()

## Step13: Grasp1

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1780
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 100

GRIPPER_FORCE_CTRL_FUNCTION()

## Step14: Grasp2

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1700
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 130

GRIPPER_FORCE_CTRL_FUNCTION()

## Step15: Magnet ON

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

##########################################_MISSION_END_##########################################
