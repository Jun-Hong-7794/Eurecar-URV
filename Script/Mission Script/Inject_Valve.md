/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*

# Define Variable
global_bool gb_bool_kinova_force_ctrl_rst = true;

# Title: Valve Recognition

## Step0: Go to Rotate Z-Position

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.3121

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)


## Step1: LRF-Kinova Vertical CTRL

LRF_KINOVA_VERTICAL_CTRL_STRUCT.desired_distance = 151.8
LRF_KINOVA_VERTICAL_CTRL_STRUCT.error = 1

LRF_KINOVA_VERTICAL_CTRL_STRUCT.s_deg = 110
LRF_KINOVA_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_KINOVA_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_VERTICAL_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_VERTICAL_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step2: LRF-Kinova Horizen CTRL

LRF_KINOVA_HORIZEN_CTRL_STRUCT.desired_inlier_deg_avr = 131.5
LRF_KINOVA_HORIZEN_CTRL_STRUCT.error = 0.25

LRF_KINOVA_HORIZEN_CTRL_STRUCT.s_deg = 110
LRF_KINOVA_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_KINOVA_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_KINOVA_HORIZEN_CTRL_STRUCT.loop_sleep = 30
LRF_KINOVA_HORIZEN_CTRL_STRUCT.sensor_option = false

LRF_KINOVA_HORIZEN_CTRL_FUNCTION()

A_Sleep(1000)


## Step3: KINOVA Force CTRL

KINOVA_FORCE_CTRL_STRUCT.step_count = 100

KINOVA_FORCE_CTRL_STRUCT.force_threshold = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_x = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_y = 0
KINOVA_FORCE_CTRL_STRUCT.force_threshold_z = -1

KINOVA_FORCE_CTRL_STRUCT.position_limit_x = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_y = 0
KINOVA_FORCE_CTRL_STRUCT.position_limit_z = 0.213

KINOVA_FORCE_CTRL_STRUCT.move_step_x = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_y = 0
KINOVA_FORCE_CTRL_STRUCT.move_step_z = -0.05

gb_bool_kinova_force_ctrl_rst = KINOVA_FORCE_CTRL_FUNCTION()
A_Sleep(1000)

## Step4: Conditionally Iteration

CONDITIONALLY_ITERATION.start_step_index = 0

/* If condition is "true", Restart from "start_step_index"
/* Else,  By Pass
CONDITIONALLY_ITERATION(!gb_bool_kinova_force_ctrl_rst)

## Step5: Gripper Release

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1780
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 80

GRIPPER_FORCE_CTRL_FUNCTION()

## Step6: Magnet OFF

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = false

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step7: Go to Rotate Z-Position

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.237

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)


## Step8: Rotate Valve

KINOVA_ROTATE_VALVE_STRUCT.using_current_coord = true

KINOVA_ROTATE_VALVE_STRUCT.center_x = 0
KINOVA_ROTATE_VALVE_STRUCT.center_y = 0
KINOVA_ROTATE_VALVE_STRUCT.center_z = 0.1223

KINOVA_ROTATE_VALVE_STRUCT.theta = -45
KINOVA_ROTATE_VALVE_STRUCT.radius = 10

KINOVA_ROTATE_VALVE_STRUCT.init_angle = false

KINOVA_ROTATE_VALVE_FUNCTION()


## Step9: Grasp1

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1780
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1600
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 100

GRIPPER_FORCE_CTRL_FUNCTION()

## Step10: Grasp2

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1700
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1700
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 130

GRIPPER_FORCE_CTRL_FUNCTION()

## Step11: Magnet ON

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)


## Step12: Rotate Valve

KINOVA_ROTATE_VALVE_STRUCT.using_current_coord = true

KINOVA_ROTATE_VALVE_STRUCT.center_x = 0
KINOVA_ROTATE_VALVE_STRUCT.center_y = 0
KINOVA_ROTATE_VALVE_STRUCT.center_z = 0.1223

KINOVA_ROTATE_VALVE_STRUCT.theta = -45
KINOVA_ROTATE_VALVE_STRUCT.radius = 10

KINOVA_ROTATE_VALVE_STRUCT.init_angle = false

KINOVA_ROTATE_VALVE_FUNCTION()

##########################################_MISSION_END_##########################################
