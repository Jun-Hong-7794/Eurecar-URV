/* Eurecar Scenario Script 
/* Made By Jun Hong 28.01.2017
/* This Script is for 2107 MBZIRC Challenge2
/*
/*<
# Title: Wrench Grasp

global_bool gb_froce_check = false;

## Step0: Align to Panel

KINOVA_ALIGN_TO_PANEL.do_init_motion = false
KINOVA_ALIGN_TO_PANEL_FUNCTION()

A_Sleep(500)

## Step1: Release
/*IF(gb_froce_check)

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 3000
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 3000
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = -2

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step2: Kinova Arm Up

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.4106

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(500)

## Step3: LRF-Kinova Vertical CTRL(NEW)

LRF_K_VERTICAL_CTRL_STRUCT.mode = 4

LRF_K_VERTICAL_CTRL_STRUCT.force_option = false
LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = false

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 300
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)


## Step4: Vehicle Horizen Control(Hanger Index > 4)

LRF_V_HORIZEN_CTRL_STRUCT.mode = 3

LRF_V_HORIZEN_CTRL_STRUCT.desired_h_dst = 885

LRF_V_HORIZEN_CTRL_STRUCT.error = 20

LRF_V_HORIZEN_CTRL_STRUCT.s_deg = 10
LRF_V_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_V_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_V_HORIZEN_CTRL_STRUCT.loop_sleep = 30
LRF_V_HORIZEN_CTRL_STRUCT.velocity = 55
LRF_V_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step5: KINOVA Angle Control(New, Using Dynamixel Pro-LRF)
/* mode =2 => Left
/* mode =3 => Right
LRF_K_ANGLE_CTRL_STRUCT.mode = 3

LRF_K_ANGLE_CTRL_STRUCT.error = 0.3
LRF_K_ANGLE_CTRL_STRUCT.desired_angle = -0

LRF_K_ANGLE_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_ANGLE_CTRL_STRUCT.s_deg = 10
LRF_K_ANGLE_CTRL_STRUCT.e_deg = 170

LRF_K_ANGLE_CTRL_STRUCT.unit_deg = 0.8

LRF_K_ANGLE_CTRL_STRUCT.loop_sleep = 30

LRF_K_ANGLE_CTRL_FUNCTION()

A_Sleep(1000)

## Step6: LRF-Kinova Vertical CTRL(NEW)

LRF_K_VERTICAL_CTRL_STRUCT.mode = 3

LRF_K_VERTICAL_CTRL_STRUCT.force_option = false
LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = true

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 300
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(500)

## Step8: LRF-Kinova Horizen CTRL(NEW)
IF(gi_wrench_hanger_index == 4)
LRF_K_HORIZEN_CTRL_STRUCT.mode = 3

LRF_K_HORIZEN_CTRL_STRUCT.only_sensing_moving = false

LRF_K_HORIZEN_CTRL_STRUCT.wrench_hanger_index = 5

LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_1 = 704 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_2 = 754 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_3 = 804 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_4 = 857
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_5 = 900 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_6 = 950

LRF_K_HORIZEN_CTRL_STRUCT.desired_h_dst = 0

LRF_K_HORIZEN_CTRL_STRUCT.error = 3

LRF_K_HORIZEN_CTRL_STRUCT.s_deg = 10 
LRF_K_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_K_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_K_HORIZEN_CTRL_STRUCT.loop_sleep = 30 

LRF_K_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step8: LRF-Kinova Horizen CTRL(NEW)
IF(gi_wrench_hanger_index == 4)
## Step7: Kinova Arm Go Right

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = --0.05
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)


## Step8: LRF-Kinova Horizen CTRL(NEW)
IF(gi_wrench_hanger_index > 4)
LRF_K_HORIZEN_CTRL_STRUCT.mode = 3

LRF_K_HORIZEN_CTRL_STRUCT.only_sensing_moving = false

LRF_K_HORIZEN_CTRL_STRUCT.wrench_hanger_index = gi_wrench_hanger_index

LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_1 = 704 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_2 = 754 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_3 = 804 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_4 = 857
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_5 = 900 
LRF_K_HORIZEN_CTRL_STRUCT.wrench_location_6 = 950

LRF_K_HORIZEN_CTRL_STRUCT.desired_h_dst = 0

LRF_K_HORIZEN_CTRL_STRUCT.error = 3

LRF_K_HORIZEN_CTRL_STRUCT.s_deg = 10 
LRF_K_HORIZEN_CTRL_STRUCT.e_deg = 170

LRF_K_HORIZEN_CTRL_STRUCT.inlier_lrf_dst = 800

LRF_K_HORIZEN_CTRL_STRUCT.loop_sleep = 30 

LRF_K_HORIZEN_CTRL_FUNCTION()

A_Sleep(500)

## Step9: Kinova Arm Down 
/*<
IF(gi_valve_size > 19)

KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.2807

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step10: Kinova Arm Down 
IF(gi_valve_size < 22)
/*>
KINOVA_MANIPULATE_STRUCT.x = ==
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = 0.2957

KINOVA_MANIPULATE_STRUCT.roll = ==
KINOVA_MANIPULATE_STRUCT.pitch = ==
KINOVA_MANIPULATE_STRUCT.yaw = ==

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

## Step11: Magnet On

GRIPPER_MAGNET_CTRL_STRUCT.fl_magnet = true

GRIPPER_MAGNET_CTRL_FUNCTION()
A_Sleep(1000)

## Step12: LRF-Kinova Go Forward

LRF_K_VERTICAL_CTRL_STRUCT.mode = 3

LRF_K_VERTICAL_CTRL_STRUCT.force_option = true

LRF_K_VERTICAL_CTRL_STRUCT.force_x = 8
LRF_K_VERTICAL_CTRL_STRUCT.force_y = 0
LRF_K_VERTICAL_CTRL_STRUCT.force_z = 0

LRF_K_VERTICAL_CTRL_STRUCT.only_sensing_moving = true

LRF_K_VERTICAL_CTRL_STRUCT.desired_v_dst = 110
LRF_K_VERTICAL_CTRL_STRUCT.error = 2

LRF_K_VERTICAL_CTRL_STRUCT.s_deg = 10
LRF_K_VERTICAL_CTRL_STRUCT.e_deg = 170

LRF_K_VERTICAL_CTRL_STRUCT.inlier_lrf_dst = 1100

LRF_K_VERTICAL_CTRL_STRUCT.loop_sleep = 30

LRF_K_VERTICAL_CTRL_FUNCTION()

A_Sleep(2000)

## Step11: Kinova Arm Go Back

KINOVA_MANIPULATE_STRUCT.mode = 2

KINOVA_MANIPULATE_STRUCT.x = --0.10
KINOVA_MANIPULATE_STRUCT.y = ==
KINOVA_MANIPULATE_STRUCT.z = ==

KINOVA_MANIPULATE_STRUCT.roll = 2.1374
KINOVA_MANIPULATE_STRUCT.pitch = 1.6015
KINOVA_MANIPULATE_STRUCT.yaw = -2.2821

KINOVA_MANIPULATE_STRUCT.force_threshold = 10

KINOVA_MANIPULATE_FUNCTION()

A_Sleep(1000)

##Step14: Grasp - 1

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1800
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1900
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = -2

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step15: Grasp - 2

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1570
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1570
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 350

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step16: Gripper Release

GRIPPER_GO_TO_REL_POSE_STRUCT.pose_1 = 30
GRIPPER_GO_TO_REL_POSE_STRUCT.pose_2 = 30

GRIPPER_GO_TO_REL_POSE_FUNCTION()

A_Sleep(500)


## Step17: Grasp2

GRIPPER_FORCE_CTRL_STRUCT.pose_1 = 1570
GRIPPER_FORCE_CTRL_STRUCT.pose_2 = 1570
GRIPPER_FORCE_CTRL_STRUCT.force_threshold = 350

GRIPPER_FORCE_CTRL_FUNCTION()

A_Sleep(500)

## Step18: Align to Panel
KINOVA_ALIGN_TO_PANEL.do_init_motion = false
KINOVA_ALIGN_TO_PANEL_FUNCTION()

##########################################_MISSION_END_##########################################
